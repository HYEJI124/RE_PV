import pandas as pd
import time
from ê¸°ìƒapi import get_kma_data  # get_kma_data í•¨ìˆ˜ê°€ ë“¤ì–´ìˆëŠ” íŒŒì¼ëª… ë§ì¶°ì£¼ì„¸ìš”

# -------------------------------------------------------
# 1ï¸âƒ£ ìˆ˜ì§‘í•  ì§€ì  ëª©ë¡ (ì§€ì ëª… â†’ ì½”ë“œ)
# -------------------------------------------------------
station_dict = {
    'ì¸ì²œ': '112',
    'ì†ì´ˆ': '90',
    'ì•ˆë™': '136',
    'ì—¬ìˆ˜': '168',
    'ê°•ë¦‰': '105',
    'êµ¬ë¯¸': '279',
    'ê´‘ì£¼': '156',
    'ì§„ì£¼': '192',
    'í†µì˜': '162',
    'ê´‘ì–‘': '266',
    'ì°½ì›': '155',
    'ì„œìš¸': '108',
    'í™ì„±': '177',
    'ì œì£¼': '184',
    'ì„œê·€í¬': '189',
    'ë³´ë ¹': '235',
    'ì„¸ì¢…': '239',
    'ìš¸ì‚°': '152',
    'ì„œì‚°': '129',
    'ë™í•´': '106'
}

# -------------------------------------------------------
# ëª¨ë“  ì§€ì  ë°ì´í„° ë°˜ë³µ ìˆ˜ì§‘
# -------------------------------------------------------
all_data = []

for name, stn_id in station_dict.items():
    print(f"ğŸ“¡ {name}({stn_id}) ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")

    df = get_kma_data(stn_id)

    if not df.empty:
        # ê²°ì¸¡ì¹˜(-9, NaN ë“±)ë¥¼ ëª¨ë‘ 0ìœ¼ë¡œ ë³€í™˜
        df = df.replace([-9, -99, -999, -9999], 0)
        df = df.fillna(0)

        # âœ… ì§€ì—­ëª… ì¶”ê°€
        df['ì§€ì—­ëª…'] = name

        all_data.append(df)
    else:
        print(f"âš ï¸ {name}({stn_id}) ë°ì´í„° ì—†ìŒ!")

    time.sleep(1.5)  # API ì„œë²„ ì°¨ë‹¨ ë°©ì§€ìš©

# -------------------------------------------------------
# 3ï¸âƒ£ ì „ì²´ ë³‘í•© ë° ì»¬ëŸ¼ ì •ë¦¬
# -------------------------------------------------------
if all_data:
    df_final = pd.concat(all_data, ignore_index=True)

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì •ë¦¬
    cols = ['ì§€ì—­ëª…', 'ë‚ ì§œ', 'í’ì†', 'ê¸°ì˜¨', 'ìŠµë„', 'ê°•ìˆ˜ëŸ‰', 'ì¼ì¡°', 'ì¼ì‚¬']
    df_final = df_final[[c for c in cols if c in df_final.columns]]

    # ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
    df_final = df_final.sort_values(['ì§€ì—­ëª…', 'ë‚ ì§œ']).reset_index(drop=True)

    print("\nìµœì¢… ë°ì´í„° ìš”ì•½:")
    print(df_final.head())

    # ---------------------------------------------------
    # CSV íŒŒì¼ ì €ì¥
    # ---------------------------------------------------
    output_file = "ì „êµ­_ì¼ë³„ê¸°ìƒë°ì´í„°_2022_2024.csv"
    df_final.to_csv(output_file, encoding='utf-8-sig', index=False)
    print(f"\nğŸ’¾ ì €ì¥ ì™„ë£Œ â†’ {output_file}")

else:
    print(" ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
