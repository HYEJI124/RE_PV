import pandas as pd

# ----------------------------------------------------------
# 1ï¸âƒ£ íŒŒì¼ ê²½ë¡œ ì„¤ì • (ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
# ----------------------------------------------------------
weather_path = '/Users/parkhyeji/Desktop/PV/data/raw/ê¸°ìƒ.csv'   # ê¸°ìƒë°ì´í„° íŒŒì¼
generation_path = '/Users/parkhyeji/Desktop/PV/data/raw/ë°œì „ëŸ‰.csv'  # ë°œì „ëŸ‰ ë°ì´í„° íŒŒì¼

# ----------------------------------------------------------
# 2ï¸âƒ£ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
# ----------------------------------------------------------
weather_df = pd.read_csv(weather_path, encoding='cp949')
generation_df = pd.read_csv(generation_path, encoding='utf-8-sig')

# ----------------------------------------------------------
# 3ï¸âƒ£ ë‚ ì§œ ì»¬ëŸ¼ì„ datetimeìœ¼ë¡œ ë³€í™˜
# ----------------------------------------------------------
# ê¸°ìƒë°ì´í„°: 'ì¼ì‹œ' / ë°œì „ë°ì´í„°: 'ë‚ ì§œ'
weather_df['ì¼ì‹œ'] = pd.to_datetime(weather_df['ì¼ì‹œ'], errors='coerce')
generation_df['ë‚ ì§œ'] = pd.to_datetime(generation_df['ë‚ ì§œ'], errors='coerce')

# ----------------------------------------------------------
# 4ï¸âƒ£ ë³‘í•© í‚¤ í†µì¼ ('ì§€ì ëª…' â†’ 'ì§€ì ')
# ----------------------------------------------------------
if 'ì§€ì ëª…' in weather_df.columns:
    weather_df = weather_df.rename(columns={'ì§€ì ëª…': 'ì§€ì '})

# ----------------------------------------------------------
# 5ï¸âƒ£ ë³‘í•© (ë°œì „ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ)
# ----------------------------------------------------------
merged_df = pd.merge(
    generation_df,
    weather_df,
    how='left',             # ë°œì „ëŸ‰ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©
    left_on=['ì§€ì ', 'ë‚ ì§œ'],
    right_on=['ì§€ì ', 'ì¼ì‹œ']
)

# ----------------------------------------------------------
# 6ï¸âƒ£ ë³‘í•© í›„ ì •ë¦¬: 'ì¼ì‹œ' ì»¬ëŸ¼ ì œê±° â†’ 'ë‚ ì§œ'ë§Œ ë‚¨ê¸°ê¸°
# ----------------------------------------------------------
if 'ì¼ì‹œ' in merged_df.columns:
    merged_df = merged_df.drop(columns=['ì¼ì‹œ'])

# ----------------------------------------------------------
# 7ï¸âƒ£ ê²°ê³¼ í™•ì¸ ë° ì €ì¥
# ----------------------------------------------------------
print("âœ… ë³‘í•© ì™„ë£Œ!")
print("ë³‘í•©ëœ ë°ì´í„°í”„ë ˆì„ í¬ê¸°:", merged_df.shape)
print(merged_df.head(3))   # ìƒìœ„ 3í–‰ë§Œ ì¶œë ¥

# ì €ì¥ ê²½ë¡œ
output_path = '/Users/parkhyeji/Desktop/PV/data/processed/ë°œì „ëŸ‰ê¸°ìƒë°ì´í„°(ë³‘í•©).csv'

# CSV íŒŒì¼ë¡œ ì €ì¥
merged_df.to_csv(output_path, index=False, encoding='utf-8-sig')

print(f"ğŸ’¾ ê²°ê³¼ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‘‰ {output_path}")
