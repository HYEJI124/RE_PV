import pandas as pd
import numpy as np
import time
import kma_api

# --------------------------------------------------
# 1. ì „êµ­ ì§€ì  ì½”ë“œ (ASOS ì§€ì  ID)
# --------------------------------------------------
station_ids = [
    # ê°•ì›íŠ¹ë³„ìì¹˜ë„
    '105','100','106','104','93','214','90','121','114','211','217','95','101','216','212',
    # ê²½ê¸°ë„
    '98','119','202','203','99',
    # ê²½ìƒë‚¨ë„
    '294','284','253','295','288','255','289','257','263','192','155','162','264','285',
    # ê²½ìƒë¶ë„
    '283','279','273','271','137','136','277','272','281','115','130','278','276','138',
    # ê´‘ì£¼ê´‘ì—­ì‹œ
    '156',
    # ëŒ€êµ¬ê´‘ì—­ì‹œ
    '143','176',
    # ëŒ€ì „ê´‘ì—­ì‹œ
    '133',
    # ë¶€ì‚°ê´‘ì—­ì‹œ
    '159','296',
    # ì„œìš¸íŠ¹ë³„ì‹œ
    '116','108',
    # ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ
    '239',
    # ìš¸ì‚°ê´‘ì—­ì‹œ
    '152',
    # ì¸ì²œê´‘ì—­ì‹œ
    '201','102','112',
    # ì „ë¼ë‚¨ë„
    '259','262','266','165','164','258','174','168','252','170','260','256','175','268','261','169',
    # ì „ë¶íŠ¹ë³„ìì¹˜ë„
    '172','251','140','247','243','254','244','248','146','245',
    # ì œì£¼íŠ¹ë³„ìì¹˜ë„
    '185','189','187','188','265','184',
    # ì¶©ì²­ë‚¨ë„
    '238','235','236','129','232','177',
    # ì¶©ì²­ë¶ë„
    '226','181','221','131','135','127'
]

# --------------------------------------------------
# 2. ì§€ì -ì‹œë„ ë§¤í•‘ ë”•ì…”ë„ˆë¦¬
# --------------------------------------------------
station_to_region = {
    '105':'ê°•ì›','100':'ê°•ì›','106':'ê°•ì›','104':'ê°•ì›','93':'ê°•ì›','214':'ê°•ì›','90':'ê°•ì›','121':'ê°•ì›','114':'ê°•ì›','211':'ê°•ì›','217':'ê°•ì›','95':'ê°•ì›','101':'ê°•ì›','216':'ê°•ì›','212':'ê°•ì›',
    '98':'ê²½ê¸°','119':'ê²½ê¸°','202':'ê²½ê¸°','203':'ê²½ê¸°','99':'ê²½ê¸°',
    '294':'ê²½ë‚¨','284':'ê²½ë‚¨','253':'ê²½ë‚¨','295':'ê²½ë‚¨','288':'ê²½ë‚¨','255':'ê²½ë‚¨','289':'ê²½ë‚¨','257':'ê²½ë‚¨','263':'ê²½ë‚¨','192':'ê²½ë‚¨','155':'ê²½ë‚¨','162':'ê²½ë‚¨','264':'ê²½ë‚¨','285':'ê²½ë‚¨',
    '283':'ê²½ë¶','279':'ê²½ë¶','273':'ê²½ë¶','271':'ê²½ë¶','137':'ê²½ë¶','136':'ê²½ë¶','277':'ê²½ë¶','272':'ê²½ë¶','281':'ê²½ë¶','115':'ê²½ë¶','130':'ê²½ë¶','278':'ê²½ë¶','276':'ê²½ë¶','138':'ê²½ë¶',
    '156':'ê´‘ì£¼',
    '143':'ëŒ€êµ¬','176':'ëŒ€êµ¬',
    '133':'ëŒ€ì „',
    '159':'ë¶€ì‚°','296':'ë¶€ì‚°',
    '116':'ì„œìš¸','108':'ì„œìš¸',
    '239':'ì„¸ì¢…',
    '152':'ìš¸ì‚°',
    '201':'ì¸ì²œ','102':'ì¸ì²œ','112':'ì¸ì²œ',
    '259':'ì „ë‚¨','262':'ì „ë‚¨','266':'ì „ë‚¨','165':'ì „ë‚¨','164':'ì „ë‚¨','258':'ì „ë‚¨','174':'ì „ë‚¨','168':'ì „ë‚¨','252':'ì „ë‚¨','170':'ì „ë‚¨','260':'ì „ë‚¨','256':'ì „ë‚¨','175':'ì „ë‚¨','268':'ì „ë‚¨','261':'ì „ë‚¨','169':'ì „ë‚¨',
    '172':'ì „ë¶','251':'ì „ë¶','140':'ì „ë¶','247':'ì „ë¶','243':'ì „ë¶','254':'ì „ë¶','244':'ì „ë¶','248':'ì „ë¶','146':'ì „ë¶','245':'ì „ë¶',
    '185':'ì œì£¼','189':'ì œì£¼','187':'ì œì£¼','188':'ì œì£¼','265':'ì œì£¼','184':'ì œì£¼',
    '238':'ì¶©ë‚¨','235':'ì¶©ë‚¨','236':'ì¶©ë‚¨','129':'ì¶©ë‚¨','232':'ì¶©ë‚¨','177':'ì¶©ë‚¨',
    '226':'ì¶©ë¶','181':'ì¶©ë¶','221':'ì¶©ë¶','131':'ì¶©ë¶','135':'ì¶©ë¶','127':'ì¶©ë¶'
}

# --------------------------------------------------
# 3. ë°ì´í„° ë¡œë”© ë° ë³‘í•©
# --------------------------------------------------
all_weather_dfs = []
failed_stations = []

print("--- ë°ì´í„° ë¡œë”© ì‹œì‘ ---")

for stn_id in station_ids:
    print(f"ì§€ì  {stn_id} ë¡œë”© ì¤‘...")
    try:
        df = kma_api.get_kma_data(stn_id)

        if df is not None and not df.empty:
            if 'ë‚ ì§œ' not in df.columns and 'ì¼ì‹œ' in df.columns:
                df = df.rename(columns={'ì¼ì‹œ': 'ë‚ ì§œ'})
            df['ì§€ì '] = stn_id

            # ì»¬ëŸ¼ëª… ì •ë¦¬
            rename_dict = {
                'í’ì†(í‰ê· )': 'í’ì†', 'ê¸°ì˜¨(í‰ê· )': 'ê¸°ì˜¨',
                'ì¼ì¡°ì‹œê°„(ì‹œê°„)': 'ì¼ì¡°ì‹œê°„', 'ì¼ì‚¬ëŸ‰(MJ/m2)': 'ì¼ì‚¬ëŸ‰'
            }
            df.rename(columns={c: rename_dict[c] for c in df.columns if c in rename_dict}, inplace=True)

            all_weather_dfs.append(df)
        else:
            print(f"âš ï¸ ì§€ì  {stn_id}: ë¹ˆ ë°ì´í„° ë˜ëŠ” None ë°˜í™˜ë¨.")
            failed_stations.append(stn_id)

    except Exception as e:
        print(f"âŒ ì§€ì  {stn_id} ì˜¤ë¥˜ ë°œìƒ: {e}")
        failed_stations.append(stn_id)

    time.sleep(0.5)

if not all_weather_dfs:
    raise ValueError("âŒ ëª¨ë“  ì§€ì  ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!")

weather_df = pd.concat(all_weather_dfs, ignore_index=True)
print("--- ë°ì´í„° ë¡œë”© ì™„ë£Œ ---")

# --------------------------------------------------
# 4. ë°ì´í„° ì •ì œ
# --------------------------------------------------
weather_df['ë‚ ì§œ'] = pd.to_datetime(weather_df['ë‚ ì§œ'], format='%Y%m%d', errors='coerce')
for col in ['í’ì†', 'ê¸°ì˜¨', 'ì¼ì¡°ì‹œê°„', 'ì¼ì‚¬ëŸ‰']:
    weather_df[col] = pd.to_numeric(weather_df[col], errors='coerce')

weather_df = weather_df.replace([-9.0, -99.0, -99.9], np.nan)
weather_df = weather_df.sort_values(by=['ì§€ì ', 'ë‚ ì§œ']).set_index('ë‚ ì§œ')

# --------------------------------------------------
# 5. ì›”ë³„ ì§‘ê³„ (í’ì†Â·ê¸°ì˜¨ í‰ê·  / ì¼ì¡°ì‹œê°„Â·ì¼ì‚¬ëŸ‰ í•©ê³„)
# --------------------------------------------------
monthly_df = (
    weather_df
    .groupby('ì§€ì ')
    .resample('M')
    .agg({
        'í’ì†': 'mean',
        'ê¸°ì˜¨': 'mean',
        'ì¼ì¡°ì‹œê°„': 'sum',
        'ì¼ì‚¬ëŸ‰': 'sum'
    })
    .reset_index()
)

monthly_df['ë‚ ì§œ'] = monthly_df['ë‚ ì§œ'].dt.to_period('M')
monthly_df['ì‹œë„'] = monthly_df['ì§€ì '].map(station_to_region)

# --------------------------------------------------
# 6. ì‹œë„ë³„ í‰ê·  ì§‘ê³„
# --------------------------------------------------
region_monthly_df = (
    monthly_df
    .groupby(['ì‹œë„', 'ë‚ ì§œ'])
    .agg({
        'í’ì†': 'mean',
        'ê¸°ì˜¨': 'mean',
        'ì¼ì¡°ì‹œê°„': 'mean',
        'ì¼ì‚¬ëŸ‰': 'mean'
    })
    .reset_index()
    .set_index(['ì‹œë„', 'ë‚ ì§œ'])
)

# --------------------------------------------------
# 7. ê²°ê³¼ í™•ì¸ ë° ì €ì¥
# --------------------------------------------------
print("\nâœ… ì‹œë„ë³„ ì›”í‰ê·  ê¸°ìƒìš”ì†Œ ê³„ì‚° ì™„ë£Œ")
print(region_monthly_df.head(15))

region_monthly_df.to_csv('region_monthly_weather.csv', encoding='utf-8-sig')
print("\nğŸ’¾ 'region_monthly_weather.csv' ì €ì¥ ì™„ë£Œ!")
